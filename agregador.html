<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Agregador - Agregar Bloque</title>
    <link rel="stylesheet" href="css/agregador.css">
    <script src="BlockChain.js"></script>
</head>
<body>
    <div class="header">
        <img src="img/cafe-icon.png" class="cafe-icon" alt="Café">
        <h1 style="display:inline;">Agregador: Añadir Movimiento de Café</h1>
        <a href="validador.html" class="nav-item nav-link active">Validador</a>
    </div>
    <div class="form-section">
        <form id="addBlockForm">
            <label for="chainName">Nombre de la cadena:</label>
            <input type="text" id="chainName" name="chainName" required placeholder="Ej: CafePremium2024">

            <label for="coffeeType">Tipo de café:</label>
            <input type="text" id="coffeeType" name="coffeeType" required placeholder="Ej: Arábica, Robusta">

            <label for="quantity">Cantidad (kg):</label>
            <input type="number" id="quantity" name="quantity" required min="1" placeholder="Ej: 50">

            <label for="buyer">Comprador:</label>
            <input type="text" id="buyer" name="buyer" required placeholder="Nombre del comprador">

            <label for="blockData">Notas adicionales:</label>
            <input type="text" id="blockData" name="blockData" placeholder="Notas (opcional)">

            <button type="submit">Agregar Movimiento</button>
        </form>
        <div id="addBlockSuccess" class="success" style="display:none;"></div>
        <div id="blockHash" class="success" style="display:none;"></div>
    </div>
    <script>
        document.getElementById('addBlockForm').onsubmit = function(e) {
            e.preventDefault();
            const name = document.getElementById('chainName').value;
            const coffeeType = document.getElementById('coffeeType').value;
            const quantity = document.getElementById('quantity').value;
            const buyer = document.getElementById('buyer').value;
            const notes = document.getElementById('blockData').value;

            // Estructura de datos del bloque
            const blockData = {
                tipoCafe: coffeeType,
                cantidad: quantity,
                comprador: buyer,
                notas: notes,
                entregado: false // Estado inicial
            };

            // Recuperar cadenas de localStorage
            let chains = JSON.parse(localStorage.getItem('chains') || '[]');
            // Reconstruir objetos Blockchain
            chains = chains.map(obj => {
                const chain = new window.Blockchain(obj.chain[0].data);
                chain.name = obj.name;
                for(let i=1; i<obj.chain.length; i++) {
                    chain.addBlock(obj.chain[i].data);
                }
                return chain;
            });
            // Buscar la cadena por nombre
            const chain = chains.find(c => c.name === name);
            if(chain) {
                const prevLength = chain.chain.length;
                chain.addBlock(blockData);
                const newBlock = chain.chain[prevLength];
                // Actualizar en localStorage
                const updatedChains = chains.map(c => c.name === name ? chain : c);
                localStorage.setItem('chains', JSON.stringify(updatedChains));
                document.getElementById('addBlockSuccess').style.display = 'block';
                document.getElementById('addBlockSuccess').textContent = `Movimiento agregado a la cadena "${name}".`;
                document.getElementById('blockHash').style.display = 'block';
                document.getElementById('blockHash').textContent = `Hash de seguimiento: ${newBlock.hash}`;
            } else {
                alert('Cadena no encontrada o BlockChain.js no cargado.');
            }
        };
    </script>
</body>
</html>
       
