<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Validador - Trazabilidad de Cadena</title>
    <link rel="stylesheet" href="css/validador.css">
    <script src="BlockChain.js"></script>
</head>
<body>
    <div class="header">
        <img src="img/cafe-icon.png" class="cafe-icon" alt="Café">
        <h1 style="display:inline;">Validador: Trazabilidad de Café</h1>
        <a href="Menu.html" class="nav-item nav-link active">Menu</a>
    </div>
    <div class="trace-section">
        <div class="select-chain">
            <label for="chainName">Selecciona la cadena:</label>
            <select id="chainName">
                <option value="">-- Selecciona --</option>
            </select>
            <button id="showTrace">Mostrar Trazabilidad</button>
        </div>
        <h2>Movimientos de la Cadena</h2>
        <ul id="chainList" class="chain-list"></ul>
    </div>
    <script>
        function getChainsFromStorage() {
            let chains = JSON.parse(localStorage.getItem('chains') || '[]');
            if (!chains || !chains.length) return [];
            return chains.map(obj => ({
                name: obj.name || (obj.chain && obj.chain[0] && obj.chain[0].data && obj.chain[0].data.nombre) || 'Sin nombre',
                chain: obj.chain || []
            }));
        }

        function updateChainOptions() {
            const select = document.getElementById('chainName');
            select.innerHTML = '<option value="">-- Selecciona --</option>';
            const chains = getChainsFromStorage();
            if(chains.length) {
                chains.forEach(chain => {
                    const opt = document.createElement('option');
                    opt.value = chain.name;
                    opt.textContent = chain.name;
                    select.appendChild(opt);
                });
            } else {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'No hay cadenas disponibles';
                select.appendChild(opt);
            }
        }

        function saveChainsToStorage(chains) {
            localStorage.setItem('chains', JSON.stringify(chains));
        }

        document.getElementById('showTrace').onclick = function() {
            const name = document.getElementById('chainName').value;
            const chains = getChainsFromStorage();
            const chain = chains.find(c => c.name === name);
            const list = document.getElementById('chainList');
            list.innerHTML = '';
            if(chain && chain.chain.length) {
                chain.chain.forEach((block, idx) => {
                    const isEntregado = block.data && block.data.entregado;
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>Movimiento #${idx}</strong><br>
                        Fecha: ${block.dateString || (block.date ? block.date : 'N/A')}<br>
                        Tipo de café: ${block.data && block.data.tipoCafe ? block.data.tipoCafe : '-'}<br>
                        Cantidad: ${block.data && block.data.cantidad ? block.data.cantidad : '-'} kg<br>
                        Comprador: ${block.data && block.data.comprador ? block.data.comprador : '-'}<br>
                        Notas: ${block.data && block.data.notas ? block.data.notas : '-'}<br>
                        Hash: <span style="font-size:0.9em;">${block.hash || 'N/A'}</span><br>
                        Estado: <span class="${isEntregado ? 'entregado' : 'no-entregado'}">${isEntregado ? 'ENTREGADO' : 'NO ENTREGADO'}</span>
                        <br>
                        <button ${isEntregado ? 'disabled' : ''} data-block="${idx}">${isEntregado ? 'Entregado' : 'Marcar como Entregado'}</button>
                        `;
                    list.appendChild(li);
                });

                // Botón de marcar como entregado
                Array.from(list.querySelectorAll('button[data-block]')).forEach(btn => {
                    btn.onclick = function() {
                        const blockIdx = parseInt(btn.getAttribute('data-block'));
                        // Actualizar en localStorage
                        let chains = JSON.parse(localStorage.getItem('chains') || '[]');
                        let chainObj = chains.find(c => c.name === name);
                        if(chainObj && chainObj.chain[blockIdx] && chainObj.chain[blockIdx].data) {
                            chainObj.chain[blockIdx].data.entregado = true;
                            localStorage.setItem('chains', JSON.stringify(chains));
                            document.getElementById('showTrace').click();
                        }
                    };
                });
            } else {
                list.innerHTML = '<li>No se encontró la cadena seleccionada o no tiene movimientos.</li>';
            }
        };
        updateChainOptions();
    </script>
</body>
</html>
  
